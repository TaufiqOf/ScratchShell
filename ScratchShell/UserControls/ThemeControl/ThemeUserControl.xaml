<UserControl
    x:Class="ScratchShell.UserControls.ThemeControl.ThemeUserControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:ScratchShell.UserControls.ThemeControl"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    mc:Ignorable="d">

    <UserControl.Resources>
        <!--  Value Converters  -->
        <local:NullToBooleanConverter x:Key="NullToBooleanConverter" />
        <local:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
        <local:ThemeCanDeleteConverter x:Key="ThemeCanDeleteConverter" />
        <local:ThemeIsSelectedConverter x:Key="ThemeIsSelectedConverter" />
        <local:ThemeIsSelectedToVisibilityConverter x:Key="ThemeIsSelectedToVisibilityConverter" />
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />

        <!--  Custom brush for selected state with fallback  -->
        <SolidColorBrush x:Key="SelectedBackgroundBrush" Color="#40007ACC" />
        <SolidColorBrush x:Key="SelectedBorderBrush" Color="#FF0078D4" />

        <!--  Theme template data template  -->
        <DataTemplate x:Key="ThemeTemplateItemTemplate" DataType="{x:Type local:ThemeTemplate}">
            <Border
                Margin="0,0,0,0"
                Padding="15"
                Background="{ui:ThemeResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{ui:ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="1"
                CornerRadius="8"
                MouseLeftButtonDown="PreviewControl_Click">
                <Border.Style>
                    <Style TargetType="Border">
                        <Style.Triggers>
                            <DataTrigger Value="True">
                                <DataTrigger.Binding>
                                    <MultiBinding Converter="{StaticResource ThemeIsSelectedConverter}">
                                        <Binding />
                                        <Binding Path="DataContext.SelectedTemplate" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                    </MultiBinding>
                                </DataTrigger.Binding>
                                <Setter Property="BorderBrush" Value="{StaticResource SelectedBorderBrush}" />
                                <Setter Property="BorderThickness" Value="3" />
                                <Setter Property="Background" Value="{StaticResource SelectedBackgroundBrush}" />
                                <Setter Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect
                                            BlurRadius="8"
                                            Opacity="0.3"
                                            ShadowDepth="2"
                                            Color="#0078D4" />
                                    </Setter.Value>
                                </Setter>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>

                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!--  Theme Name and Default Badge  -->
                    <Grid Grid.Row="0" Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <TextBlock
                            Grid.Column="0"
                            FontSize="16"
                            FontWeight="SemiBold"
                            Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"
                            Text="{Binding Name}"
                            TextTrimming="CharacterEllipsis" />

                        <ui:Badge
                            Grid.Column="1"
                            Margin="8,0,4,0"
                            Appearance="Info"
                            Content="Default"
                            Visibility="{Binding IsDefault, Converter={StaticResource BooleanToVisibilityConverter}}" />

                        <ui:Badge
                            Grid.Column="2"
                            Margin="4,0,8,0"
                            Appearance="Success"
                            Content="SELECTED">
                            <ui:Badge.Visibility>
                                <MultiBinding Converter="{StaticResource ThemeIsSelectedToVisibilityConverter}">
                                    <Binding />
                                    <Binding Path="DataContext.SelectedTemplate" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                </MultiBinding>
                            </ui:Badge.Visibility>
                        </ui:Badge>

                        <ui:Button
                            Grid.Column="3"
                            Appearance="Primary"
                            Click="ApplyThemeItem_Click"
                            Icon="{ui:SymbolIcon Checkmark24}" />
                    </Grid>

                    <!--  Theme Description  -->
                    <TextBlock
                        Grid.Row="1"
                        Margin="0,0,0,12"
                        FontSize="12"
                        Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                        Text="{Binding Description}"
                        TextWrapping="Wrap" />

                    <!--  Terminal Preview  -->
                    <Border
                        Grid.Row="2"
                        Margin="0,0,0,12"
                        Background="{ui:ThemeResource ControlFillColorDefaultBrush}"
                        BorderBrush="{ui:ThemeResource ControlStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="4"
                        Cursor="Hand">
                        <local:TerminalPreviewControl Height="165" Theme="{Binding Theme}" />
                        <Border.Style>
                            <Style TargetType="Border">
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="BorderBrush" Value="{ui:ThemeResource AccentTextFillColorPrimaryBrush}" />
                                        <Setter Property="BorderThickness" Value="2" />
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                    </Border>

                    <!--  Theme Metadata  -->
                    <StackPanel
                        Grid.Row="3"
                        Margin="0,0,0,12"
                        Orientation="Horizontal">
                        <TextBlock
                            FontSize="10"
                            Foreground="{ui:ThemeResource TextFillColorTertiaryBrush}"
                            Text="{Binding ModifiedDate, StringFormat='Modified: {0:MM/dd/yyyy}'}" />
                    </StackPanel>

                    <!--  Apply Button  -->

                </Grid>
            </Border>
        </DataTemplate>
    </UserControl.Resources>



    <ui:Card
        Margin="0,0,0,0"
        Padding="5"
        HorizontalAlignment="Stretch"
        VerticalAlignment="Top"
        VerticalContentAlignment="Top">

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!--  Header Section  -->
            <Grid Grid.Row="0" Margin="0,0,0,5">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>


                <!--  Action Buttons  -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <ui:Button
                        Margin="0,0,5,0"
                        Appearance="Primary"
                        Click="NewTheme_Click"
                        Icon="{ui:SymbolIcon Add24}" />

                    <ui:Button
                        Margin="0,0,5,0"
                        Click="EditTheme_Click"
                        Icon="{ui:SymbolIcon Edit24}"
                        IsEnabled="{Binding SelectedTemplate, Converter={StaticResource NullToBooleanConverter}}" />

                    <ui:Button Click="DeleteTheme_Click" Icon="{ui:SymbolIcon Delete24}">
                        <ui:Button.IsEnabled>
                            <MultiBinding Converter="{StaticResource ThemeCanDeleteConverter}">
                                <Binding Path="SelectedTemplate" />
                                <Binding Path="SelectedTemplate.IsDefault" />
                            </MultiBinding>
                        </ui:Button.IsEnabled>
                    </ui:Button>
                </StackPanel>
            </Grid>
            <Separator
                Grid.Row="1"
                Height="2"
                Margin="0,0,0,0" />
            <!--  Theme Templates List  -->
            <ScrollViewer
                Grid.Row="2"
                Margin="0,5,0,0"
                CanContentScroll="False"
                HorizontalScrollBarVisibility="Disabled"
                PanningMode="VerticalOnly"
                VerticalScrollBarVisibility="Auto">
                <ItemsControl ItemTemplate="{StaticResource ThemeTemplateItemTemplate}" ItemsSource="{Binding ThemeTemplates}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <UniformGrid Columns="1" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>
            </ScrollViewer>
        </Grid>
    </ui:Card>
</UserControl>